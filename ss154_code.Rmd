---
title: "A Joint Inquiry: Marijuana Legalizationâ€™s Influence on Alcohol Misuse"
output: html_document
date: "2025-04-15"
---

```{r include=FALSE, message=FALSE, warning=FALSE}
# List of packages
packages <- c("tidyverse", "lubridate", "ggplot2", "Synth", "did", "readr", "dplyr", "fixest","modelsummary")

# Install if missing
installed <- packages %in% rownames(installed.packages())
if (any(!installed)) install.packages(packages[!installed])

# Load packages
lapply(packages, library, character.only = TRUE)
```

```{r echo=TRUE, message=FALSE}
data <- read_csv("data.csv")
head(data)
summary(data)
```

```{r}

data <- data %>%
  mutate(
    Post = ifelse(!is.na(Legalization_Year) & Year >= Legalization_Year, 1, 0)
  )

did_model <- feols(
  Binge_Drinking_Prevalence ~ i(Post, Legalized, ref = 0) + Bachelors_Rate + Median_Age + Urbanization_Rate | State + Year,
  data = data
)

summary(did_model)
```
```{r table}
modelsummary(did_model,
             stars = TRUE,
             fmt = 3,
             estimate = "{estimate} ({std.error})",
             statistic = NULL,
             title = "Difference-in-Differences Regression Results",
             output = "markdown")


```

```{r plot1}
ggplot(data, aes(x = Year, y = Binge_Drinking_Prevalence, group = State, color = as.factor(Legalized))) +
  geom_line(alpha = 0.5, size = 0.4) +
  scale_color_manual(
    values = c("0" = "darkgray", "1" = "darkgreen"),
    labels = c("0" = "Not Legalized", "1" = "Legalized"),
    name = "Legal Status"
  ) +
  labs(
    title = "Binge Drinking Prevalence Over Time by State",
    subtitle = "Lines represent individual states; color indicates legalization status",
    x = "Year",
    y = "Binge Drinking Prevalence (%)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")


```
```{r plot2}


# Create average trends by treatment status
avg_trends <- data %>%
  group_by(Year, Legalized) %>%
  summarize(
    avg_binge = mean(Binge_Drinking_Prevalence, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    Legalized = ifelse(Legalized == 1, "Treated (Legalized)", "Control (Not Legalized)")
  )

# Plot
ggplot(avg_trends, aes(x = Year, y = avg_binge, color = Legalized)) +
  geom_line(size = 1.1) +
  geom_point(size = 2) +
  scale_color_manual(
    values = c("Treated (Legalized)" = "darkgreen", "Control (Not Legalized)" = "gray60")
  ) +
  labs(
    title = "Average Binge Drinking Prevalence Over Time",
    subtitle = "Comparing Treated vs. Control States",
    x = "Year",
    y = "Average Binge Drinking Prevalence (%)",
    color = "Group"
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "bottom")

```
```{r plot2.1}
# Extract model estimates
did_df <- broom::tidy(did_model) %>%
  filter(str_detect(term, "Post::1:Legalized")) %>%
  mutate(
    lower = estimate - 1.96 * std.error,
    upper = estimate + 1.96 * std.error
  )

# Plot
ggplot(did_df, aes(x = term, y = estimate)) +
  geom_point(size = 3, color = "darkred") +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.15, color = "darkred") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray60") +
  labs(
    title = "Estimated DiD Treatment Effect",
    subtitle = "Effect of Marijuana Legalization on Binge Drinking Prevalence",
    x = "",
    y = "Estimated Effect (percentage points)"
  ) +
  theme_minimal(base_size = 13)

```

```{r plot4}
# Treated states with cohort year
treated_data <- data %>%
  filter(!is.na(Legalization_Year)) %>%
  mutate(Cohort = as.factor(Legalization_Year))

# Control group
control_data <- data %>%
  filter(is.na(Legalization_Year)) %>%
  mutate(Cohort = "Control")

# Combine both groups
combined_data <- bind_rows(treated_data, control_data)

# Average binge drinking by group and year
avg_trends <- combined_data %>%
  group_by(Year, Cohort) %>%
  summarise(Avg_Binge = mean(Binge_Drinking_Prevalence, na.rm = TRUE), .groups = "drop")

# Get legalization years per cohort (excluding control)
cohort_lines <- treated_data %>%
  distinct(Cohort, Legalization_Year)

# Plot
ggplot(avg_trends, aes(x = Year, y = Avg_Binge, color = Cohort)) +
  geom_line(size = 1.1) +
  geom_point(size = 2) +
  # Add vertical line for each treated cohort
  geom_vline(data = cohort_lines, aes(xintercept = Legalization_Year, color = Cohort),
             linetype = "dashed", show.legend = FALSE) +
  labs(
    title = "Binge Drinking Trends by Legalization Cohort and Control Group",
    subtitle = "Dashed lines mark legalization years for each cohort",
    x = "Year",
    y = "Avg. Binge Drinking Prevalence (%)",
    color = "Group"
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "bottom")
```

```{r plot5}
# Group treated states by their cohort
cohort_states <- data %>%
  filter(!is.na(Legalization_Year)) %>%
  distinct(State, State_Abbr, Legalization_Year) %>%
  mutate(Cohort = as.factor(Legalization_Year)) %>%
  arrange(Cohort)

control_states <- data %>%
  filter(is.na(Legalization_Year)) %>%
  distinct(State, State_Abbr) %>%
  mutate(Cohort = "Control") %>%
  arrange(State)

# Combine treated and control states
state_cohorts <- bind_rows(cohort_states, control_states)

# View the result
print(state_cohorts)
```
```{r plot6}
#More detail on plot 5

# Label treated states with cohort (legalization year)
treated_data <- data %>%
  filter(!is.na(Legalization_Year)) %>%
  mutate(Cohort = as.factor(Legalization_Year))

# Create average line for control group
control_avg <- data %>%
  filter(is.na(Legalization_Year)) %>%
  group_by(Year) %>%
  summarise(
    Avg_Binge = mean(Binge_Drinking_Prevalence, na.rm = TRUE),
    .groups = "drop"
  )

# Plot
ggplot() +
  # Plot individual treated states, color-coded by cohort
  geom_line(data = treated_data,
            aes(x = Year, y = Binge_Drinking_Prevalence, group = State, color = Cohort),
            alpha = 0.7, size = 0.5) +

  # Add control group average line
  geom_line(data = control_avg,
            aes(x = Year, y = Avg_Binge),
            color = "grey60", linetype = "solid", size = 1) +

  labs(
    title = "Treated States Colored by Cohort; Control Group Averaged",
    subtitle = "Each treated state shown individually; control group shown as single average line",
    x = "Year",
    y = "Binge Drinking Prevalence (%)",
    color = "Legalization Cohort"
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "bottom")

```


# OLD CODE
```{r other1}
# Extract regression summary as a tidy data frame
library(broom)

# Convert model summary to a data frame
df <- tidy(did_model)

# Add confidence intervals
df <- df %>%
  mutate(
    lower = estimate - 1.96 * std.error,
    upper = estimate + 1.96 * std.error
  )

# Plot
ggplot(df, aes(x = term, y = estimate)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
  coord_flip() +
  labs(
    title = "Coefficient Plot",
    x = "Covariates",
    y = "Estimate (with 95% CI)"
  ) +
  theme_minimal(base_size = 14)

```

```{r other2}

library(ggplot2)

ggplot(data, aes(x = Year, y = Binge_Drinking_Prevalence, group = State, color = as.factor(Legalized))) +
  geom_line(alpha = 0.6) +
  labs(
    title = "Binge Drinking Prevalence Over Time by State",
    x = "Year",
    y = "Binge Drinking Prevalence (%)",
    color = "Legalized"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r other3}

data_aligned <- data %>%
  filter(!is.na(Legalization_Year)) %>%
  mutate(relative_year = Year - Legalization_Year)

ggplot(data_aligned, aes(x = relative_year, y = Binge_Drinking_Prevalence, group = State)) +
  geom_line(alpha = 0.3, color = "gray") +
  stat_summary(fun = mean, geom = "line", color = "orange", linewidth = .8) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Binge Drinking Trends Aligned to Legalization Year",
    x = "Years Relative to Legalization",
    y = "Binge Drinking Prevalence (%)"
  ) +
  theme_minimal()

```


```{r other4}
data_normalized <- data %>%
  filter(!is.na(Legalization_Year)) %>%
  mutate(relative_year = Year - Legalization_Year) %>%
  group_by(State) %>%
  mutate(
    baseline = Binge_Drinking_Prevalence[relative_year == 0],
    normalized_prevalence = Binge_Drinking_Prevalence - baseline
  ) %>%
  ungroup()

ggplot(data_normalized, aes(x = relative_year, y = normalized_prevalence, group = State)) +
  geom_line(alpha = 0.3, color = "gray") +
  stat_summary(fun = mean, geom = "line", color = "orange", size = .5) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Normalized Binge Drinking Trends (Aligned to Legalization Year)",
    x = "Years Relative to Legalization",
    y = "Change in Binge Drinking Prevalence (%)"
  ) +
  theme_minimal()
```


```{r other6}
data_control <- data %>%
  filter(Legalized == 0) %>%
  mutate(relative_year = Year - 2016) %>%
  group_by(State) %>%
  mutate(
    baseline = Binge_Drinking_Prevalence[Year == 2016],
    normalized_prevalence = Binge_Drinking_Prevalence - baseline
  ) %>%
  ungroup()

ggplot(data_control, aes(x = relative_year, y = normalized_prevalence, group = State)) +
  geom_line(alpha = 0.3, color = "gray") +
  stat_summary(fun = mean, geom = "line", color = "orange", size = .3) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Normalized Binge Drinking Trends (Control States Aligned at 2016)",
    x = "Years Relative to 2016 (Placebo Treatment Year)",
    y = "Change in Binge Drinking Prevalence (%)"
  ) +
  theme_minimal()

```



```{r other7}
# Add group label to each dataset
data_treated <- data %>%
  filter(!is.na(Legalization_Year)) %>%
  mutate(
    relative_year = Year - Legalization_Year,
    Group = "Treated"
  ) %>%
  group_by(State) %>%
  mutate(
    baseline = Binge_Drinking_Prevalence[relative_year == 0],
    normalized_prevalence = Binge_Drinking_Prevalence - baseline
  ) %>%
  ungroup()

data_control <- data %>%
  filter(Legalized == 0) %>%
  mutate(
    relative_year = Year - 2016,
    Group = "Control"
  ) %>%
  group_by(State) %>%
  mutate(
    baseline = Binge_Drinking_Prevalence[Year == 2016],
    normalized_prevalence = Binge_Drinking_Prevalence - baseline
  ) %>%
  ungroup()

# Combine both datasets
data_combined <- bind_rows(data_treated, data_control)

# Plot
ggplot(data_combined, aes(x = relative_year, y = normalized_prevalence, group = State)) +
  geom_line(alpha = 0.15, color = "gray") +
  stat_summary(aes(color = Group), fun = mean, geom = "line", size = 0.3) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Normalized Binge Drinking Trends: Treated vs. Control (Aligned by Year)",
    x = "Years Relative to Treatment or 2016",
    y = "Change in Binge Drinking Prevalence (%)",
    color = "Group"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```


```{r other8}
states_il <- c("IL", "NE", "KS", "IA", "AR", "OK")

did_data_il <- data %>%
  filter(State_Abbr %in% states_il)

# Illinois legalized in 2020
did_data_il <- did_data_il %>%
  mutate(
    Treated = ifelse(State_Abbr == "IL", 1, 0),
    Post = ifelse(Year >= 2020, 1, 0),
    DiD = Treated * Post
  )

did_model_il <- lm(
  Binge_Drinking_Prevalence ~ DiD + Bachelors_Rate + Median_Age + Urbanization_Rate,
  data = did_data_il
)

summary(did_model_il)
library(broom)

tidy(did_model_il) %>%
  filter(term == "DiD") %>%
  ggplot(aes(x = term, y = estimate)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = estimate - 1.96 * std.error,
                    ymax = estimate + 1.96 * std.error), width = 0.2) +
  labs(
    title = "DiD Estimate: Illinois vs. Border States",
    x = "",
    y = "Estimated Effect on Binge Drinking (%)"
  ) +
  theme_minimal()

# Filter and label data
did_data_il <- data %>%
  filter(State_Abbr %in% states_il) %>%
  mutate(Group = ifelse(State_Abbr == "IL", "Illinois (Treated)", "Control States"))

# Summarize by year and group
avg_trend <- did_data_il %>%
  group_by(Year, Group) %>%
  summarise(mean_prevalence = mean(Binge_Drinking_Prevalence, na.rm = TRUE), .groups = "drop")

# Plot
ggplot(avg_trend, aes(x = Year, y = mean_prevalence, color = Group)) +
  geom_line(size = 1.1) +
  geom_vline(xintercept = 2020, linetype = "dashed", color = "red") +
  labs(
    title = "Binge Drinking Prevalence Over Time",
    subtitle = "Illinois (Treated) vs. Border States (Controls)",
    x = "Year",
    y = "Avg. Binge Drinking Prevalence (%)",
    color = "Group"
  ) +
  theme_minimal(base_size = 14)
```









```